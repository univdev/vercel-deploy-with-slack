(function(r,f){typeof exports=="object"&&typeof module<"u"?module.exports=f():typeof define=="function"&&define.amd?define(f):(r=typeof globalThis<"u"?globalThis:r||self,r.VercelDeployWithSlack=f())})(this,function(){"use strict";var le=Object.defineProperty;var ce=(r,f,P)=>f in r?le(r,f,{enumerable:!0,configurable:!0,writable:!0,value:P}):r[f]=P;var k=(r,f,P)=>ce(r,typeof f!="symbol"?f+"":f,P);var r=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function f(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var P={};(function(t){var a={},s=r&&r.__createBinding||(Object.create?function(e,n,i,u){u===void 0&&(u=i);var y=Object.getOwnPropertyDescriptor(n,i);(!y||("get"in y?!n.__esModule:y.writable||y.configurable))&&(y={enumerable:!0,get:function(){return n[i]}}),Object.defineProperty(e,u,y)}:function(e,n,i,u){u===void 0&&(u=i),e[u]=n[i]}),c=r&&r.__setModuleDefault||(Object.create?function(e,n){Object.defineProperty(e,"default",{enumerable:!0,value:n})}:function(e,n){e.default=n}),o=r&&r.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(e!=null)for(var i in e)i!=="default"&&Object.prototype.hasOwnProperty.call(e,i)&&s(n,e,i);return c(n,e),n},m=r&&r.__awaiter||function(e,n,i,u){function y(T){return T instanceof i?T:new i(function(S){S(T)})}return new(i||(i=Promise))(function(T,S){function ue(w){try{E(u.next(w))}catch(F){S(F)}}function re(w){try{E(u.throw(w))}catch(F){S(F)}}function E(w){w.done?T(w.value):y(w.value).then(ue,re)}E((u=u.apply(e,n||[])).next())})};Object.defineProperty(t,"__esModule",{value:!0}),t.platform=t.toPlatformPath=t.toWin32Path=t.toPosixPath=t.markdownSummary=t.summary=t.getIDToken=t.getState=t.saveState=t.group=t.endGroup=t.startGroup=t.info=t.notice=t.warning=t.error=t.debug=t.isDebug=t.setFailed=t.setCommandEcho=t.setOutput=t.getBooleanInput=t.getMultilineInput=t.getInput=t.addPath=t.setSecret=t.exportVariable=t.ExitCode=void 0;const l=(void 0)("./command"),d=(void 0)("./file-command"),p=(void 0)("./utils"),_=o((void 0)("os")),g=o((void 0)("path")),b=(void 0)("./oidc-utils");var v;(function(e){e[e.Success=0]="Success",e[e.Failure=1]="Failure"})(v||(t.ExitCode=v={}));function R(e,n){const i=(0,p.toCommandValue)(n);if(a[e]=i,a.GITHUB_ENV||"")return(0,d.issueFileCommand)("ENV",(0,d.prepareKeyValueMessage)(e,n));(0,l.issueCommand)("set-env",{name:e},i)}t.exportVariable=R;function W(e){(0,l.issueCommand)("add-mask",{},e)}t.setSecret=W;function N(e){a.GITHUB_PATH||""?(0,d.issueFileCommand)("PATH",e):(0,l.issueCommand)("add-path",{},e),a.PATH=`${e}${g.delimiter}${a.PATH}`}t.addPath=N;function I(e,n){const i=a[`INPUT_${e.replace(/ /g,"_").toUpperCase()}`]||"";if(n&&n.required&&!i)throw new Error(`Input required and not supplied: ${e}`);return n&&n.trimWhitespace===!1?i:i.trim()}t.getInput=I;function L(e,n){const i=I(e,n).split(`
`).filter(u=>u!=="");return n&&n.trimWhitespace===!1?i:i.map(u=>u.trim())}t.getMultilineInput=L;function K(e,n){const i=["true","True","TRUE"],u=["false","False","FALSE"],y=I(e,n);if(i.includes(y))return!0;if(u.includes(y))return!1;throw new TypeError(`Input does not meet YAML 1.2 "Core Schema" specification: ${e}
Support boolean input list: \`true | True | TRUE | false | False | FALSE\``)}t.getBooleanInput=K;function q(e,n){if(a.GITHUB_OUTPUT||"")return(0,d.issueFileCommand)("OUTPUT",(0,d.prepareKeyValueMessage)(e,n));process.stdout.write(_.EOL),(0,l.issueCommand)("set-output",{name:e},(0,p.toCommandValue)(n))}t.setOutput=q;function J(e){(0,l.issue)("echo",e?"on":"off")}t.setCommandEcho=J;function X(e){process.exitCode=v.Failure,j(e)}t.setFailed=X;function Y(){return a.RUNNER_DEBUG==="1"}t.isDebug=Y;function z(e){(0,l.issueCommand)("debug",{},e)}t.debug=z;function j(e,n={}){(0,l.issueCommand)("error",(0,p.toCommandProperties)(n),e instanceof Error?e.toString():e)}t.error=j;function Q(e,n={}){(0,l.issueCommand)("warning",(0,p.toCommandProperties)(n),e instanceof Error?e.toString():e)}t.warning=Q;function Z(e,n={}){(0,l.issueCommand)("notice",(0,p.toCommandProperties)(n),e instanceof Error?e.toString():e)}t.notice=Z;function x(e){process.stdout.write(e+_.EOL)}t.info=x;function D(e){(0,l.issue)("group",e)}t.startGroup=D;function U(){(0,l.issue)("endgroup")}t.endGroup=U;function ee(e,n){return m(this,void 0,void 0,function*(){D(e);let i;try{i=yield n()}finally{U()}return i})}t.group=ee;function te(e,n){if(a.GITHUB_STATE||"")return(0,d.issueFileCommand)("STATE",(0,d.prepareKeyValueMessage)(e,n));(0,l.issueCommand)("save-state",{name:e},(0,p.toCommandValue)(n))}t.saveState=te;function ne(e){return a[`STATE_${e}`]||""}t.getState=ne;function ae(e){return m(this,void 0,void 0,function*(){return yield b.OidcClient.getIDToken(e)})}t.getIDToken=ae;var ie=(void 0)("./summary");Object.defineProperty(t,"summary",{enumerable:!0,get:function(){return ie.summary}});var oe=(void 0)("./summary");Object.defineProperty(t,"markdownSummary",{enumerable:!0,get:function(){return oe.markdownSummary}});var O=(void 0)("./path-utils");Object.defineProperty(t,"toPosixPath",{enumerable:!0,get:function(){return O.toPosixPath}}),Object.defineProperty(t,"toWin32Path",{enumerable:!0,get:function(){return O.toWin32Path}}),Object.defineProperty(t,"toPlatformPath",{enumerable:!0,get:function(){return O.toPlatformPath}}),t.platform=o((void 0)("./platform"))})(P);const h=f(P),$={};class V{constructor(a){k(this,"token");this.token=a}pull(){return new Promise((a,s)=>{(void 0)(`npx vercel build --token=${this.token} --yes`,(c,o)=>{if(c){s(`Failed pull environment from Vercel: ${c}`);return}a(o)})})}build(){return new Promise((a,s)=>{(void 0)(`npx vercel build --token=${this.token}`,(c,o)=>{if(c){s(`Build failed: ${c}`);return}a(o)})})}deploy(){return new Promise((a,s)=>{(void 0)(`npx vercel --token=${this.token} --prod`,(c,o)=>{if(c){s(`Deploy failed: ${c}`);return}a(o)})})}}class G{constructor(a){k(this,"webhookUrl");this.webhookUrl=a}send(a){return new Promise((s,c)=>{(void 0)(`curl -X POST -H 'Content-type: application/json' --data '${a}'`,(o,m)=>{if(o){c(`Failed send slack message: ${o}`);return}s(m)})})}}class M{constructor(){k(this,"date",null)}start(){this.date=new Date}stop(){const a=this.date,s=new Date;return a===null?0:s.getTime()-a.getTime()}}class B{read(a,s=!1){return new Promise((c,o)=>{(void 0)(a,(m,l)=>{if(m){o(`Could not read the file: ${m}`);return}try{const d=l.toString("utf8");if(s===!1){c(d);return}const p=JSON.parse(d);c(p)}catch(d){o(`Could not parse the fileData: ${d}`)}})})}}var A={};class C{static workspacePath(a){return a?$.resolve(A.GITHUB_WORKSPACE,a):void 0}}async function H(){const t=new B,a=new M;a.start();const s=h.getInput("slack-webhook-url"),c=h.getInput("vercel-token-id");let o=h.getInput("slack-deploy-start-message-payload"),m=h.getInput("slack-deploy-failed-message-payload"),l=h.getInput("slack-deploy-succeed-message-payload");const d=C.workspacePath(h.getInput("slack-deploy-start-message-payload-file")),p=C.workspacePath(h.getInput("slack-deploy-failed-message-payload-file")),_=C.workspacePath(h.getInput("slack-deploy-succeed-message-payload-file")),g=s?new G(s):null,b=new V(c);try{d&&(o=await t.read(d)),_&&(l=await t.read(_)),g!==null&&o&&await g.send(o),await b.pull(),await b.build(),await b.deploy(),g!==null&&l&&await g.send(l),h.setOutput("process-time",a.stop())}catch(v){v instanceof Error&&(h.setFailed(v.message),p&&(m=await t.read(p)),g!==null&&m&&g.send(m))}}return H});
